<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pok√©Beats ‚Äî Tu equipo Pok√©mon musical</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#0d1117;--bg-mid:#161b22;--bg-card:#0f2847;--green:#1DB954;--green2:#1ed760;--yellow:#FFD700;--text:#e6edf3;--text2:#8b949e;--text3:#484f58;--radius:16px}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:-200px;left:-200px;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(29,185,84,.08) 0%,transparent 70%);pointer-events:none;z-index:0}
body::after{content:'';position:fixed;bottom:-200px;right:-200px;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(255,215,0,.05) 0%,transparent 70%);pointer-events:none;z-index:0}
.screen{display:none;min-height:100vh;position:relative;z-index:1}
.screen.active{display:flex}

/* ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ */
#landing{flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center}
.pokeball-wrap{width:100px;height:100px;margin-bottom:28px;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.pokeball-svg{width:100%;height:100%;filter:drop-shadow(0 0 20px rgba(29,185,84,.4))}
.title{font-size:clamp(36px,8vw,52px);font-weight:900;letter-spacing:-1px;margin-bottom:12px}
.title span{color:var(--green);text-shadow:0 0 30px rgba(29,185,84,.5)}
.tagline{font-size:16px;color:var(--text2);max-width:340px;line-height:1.6}
.divider{width:50px;height:3px;background:var(--green);border-radius:2px;margin:24px auto;opacity:.6}
.desc{font-size:14px;color:var(--text3);max-width:320px;line-height:1.7;margin-bottom:36px}
.btn-spotify{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(90deg,var(--green),var(--green2));color:#fff;font-family:'Nunito',sans-serif;font-size:17px;font-weight:700;border:none;border-radius:50px;cursor:pointer;padding:16px 32px;transition:transform .15s;box-shadow:0 0 30px rgba(29,185,84,.3)}
.btn-spotify:hover{transform:scale(1.04)}
.btn-spotify svg{width:22px;height:22px;fill:#fff}
.attribution{margin-top:48px;font-size:11px;color:var(--text3);opacity:.7}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loading{flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center;gap:20px}
.spin-ball{width:80px;height:80px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loading-msg{font-size:18px;font-weight:700}
#loading-sub{font-size:14px;color:var(--text2)}

/* ‚îÄ‚îÄ MEDAL SCREEN ‚îÄ‚îÄ */
#medal-screen{flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;text-align:center;gap:0}
.medal-intro{font-size:15px;color:var(--text2);margin-bottom:28px;max-width:280px;line-height:1.6}

/* Card container */
.card-scene{perspective:1000px;width:200px;height:280px;margin:0 auto 20px;cursor:pointer;user-select:none}
.card-body{width:100%;height:100%;position:relative;transform-style:preserve-3d}

/* Spinning state */
.card-body.spinning{animation:cardSpin 1.6s linear infinite}
@keyframes cardSpin{from{transform:rotateY(0)}to{transform:rotateY(360deg)}}

/* Stopping state */
.card-body.stopping{animation:cardSpin 1.6s linear 1 forwards}

/* Revealed state */
.card-body.revealed{animation:none!important;transform:rotateY(180deg)!important;transition:transform .9s cubic-bezier(.4,0,.2,1)!important}

.card-side{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:20px}

/* Mystery back */
.card-back{background:linear-gradient(135deg,#1a0a2e,#0f2847,#0a1a2e);border:2px solid rgba(255,215,0,.4);box-shadow:0 0 40px rgba(255,215,0,.15),inset 0 0 30px rgba(138,43,226,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
.card-back::before{content:'';position:absolute;inset:0;border-radius:18px;background:linear-gradient(105deg,transparent 40%,rgba(255,255,255,.09) 50%,transparent 60%);background-size:200% 200%;animation:shimmer 1.5s linear infinite}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.mystery-symbol{font-size:28px;color:rgba(255,215,0,.7);letter-spacing:3px;text-transform:uppercase;font-weight:800;margin-top:8px}

/* Pokeball SVG on back */
.pokeball-on-card{width:90px;height:90px;filter:drop-shadow(0 0 16px rgba(255,215,0,.5));animation:symbolPulse 1.8s ease-in-out infinite}
@keyframes symbolPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 0 16px rgba(255,215,0,.5))}50%{transform:scale(1.1);filter:drop-shadow(0 0 32px rgba(255,215,0,.9))}}

/* Medal front */
.card-front{background:linear-gradient(135deg,#1a0533,#0f2847,#001a33);border:2px solid rgba(255,215,0,.5);box-shadow:0 0 50px rgba(255,215,0,.3);transform:rotateY(180deg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;gap:8px}
.medal-emoji-big{font-size:72px;filter:drop-shadow(0 0 24px rgba(255,215,0,.8))}
.medal-name-big{font-size:16px;font-weight:900;background:linear-gradient(135deg,var(--yellow),#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.medal-desc-text{font-size:10px;color:var(--text2);line-height:1.5;text-align:center}

.tap-hint{font-size:13px;color:var(--text3);animation:blink 1.5s ease-in-out infinite;margin-bottom:16px}
@keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}

.btn-gold{display:none;align-items:center;gap:8px;background:linear-gradient(90deg,var(--yellow),#ffaa00);color:#000;font-family:'Nunito',sans-serif;font-size:15px;font-weight:900;border:none;border-radius:50px;cursor:pointer;padding:13px 28px;box-shadow:0 0 30px rgba(255,215,0,.4);animation:goldPulse 2s ease-in-out infinite}
.btn-gold.show{display:inline-flex}
@keyframes goldPulse{0%,100%{box-shadow:0 0 20px rgba(255,215,0,.4)}50%{box-shadow:0 0 50px rgba(255,215,0,.9)}}
.btn-gold:hover{transform:scale(1.05)}

/* ‚îÄ‚îÄ SPARKLES ‚îÄ‚îÄ */
.sparkles-overlay{position:fixed;inset:0;pointer-events:none;z-index:9999;display:none}
.sparkles-overlay.on{display:block}
.sparkle{position:absolute;border-radius:50%;animation:sparkleFly 1.2s ease-out forwards}
@keyframes sparkleFly{0%{transform:scale(0) translate(0,0);opacity:1}100%{transform:scale(1) translate(var(--tx),var(--ty));opacity:0}}

/* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
#results{flex-direction:column;align-items:center;padding:20px 14px 48px}
.results-inner{width:100%;max-width:500px}
.res-header{text-align:center;margin-bottom:18px}
.zap-icon{font-size:24px;margin-bottom:6px}
.res-title{font-size:16px;font-weight:800;line-height:1.5;margin-bottom:8px;background:linear-gradient(135deg,#fff 40%,var(--yellow));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.res-username{color:var(--green);font-size:14px;font-weight:700;margin-bottom:8px}
.medal-mini-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.3);border-radius:50px;padding:5px 12px;margin-bottom:12px;font-size:12px;font-weight:800;color:var(--yellow)}
.badges{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-bottom:6px}
.badge{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid}

/* ‚îÄ‚îÄ FLIP CARDS ‚îÄ‚îÄ */
.team-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
@media(max-width:380px){.team-grid{grid-template-columns:repeat(2,1fr)}}

.flip-wrap{perspective:800px;cursor:pointer;animation:popIn .5s ease backwards}
.flip-wrap:nth-child(1){animation-delay:.0s}
.flip-wrap:nth-child(2){animation-delay:.1s}
.flip-wrap:nth-child(3){animation-delay:.2s}
.flip-wrap:nth-child(4){animation-delay:.3s}
.flip-wrap:nth-child(5){animation-delay:.4s}
.flip-wrap:nth-child(6){animation-delay:.5s}
@keyframes popIn{from{opacity:0;transform:scale(.5)}to{opacity:1;transform:scale(1)}}

.flip-inner{width:100%;aspect-ratio:.68;position:relative;transform-style:preserve-3d;transition:transform .7s cubic-bezier(.4,0,.2,1)}
.flip-inner.flipped{transform:rotateY(180deg)}

.flip-f,.flip-b{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:var(--radius)}

/* Front mystery */
.flip-f{background:linear-gradient(135deg,#1a0a2e,#0f2847);border:1.5px solid rgba(255,215,0,.3);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;overflow:hidden}
.flip-f::before{content:'';position:absolute;inset:0;border-radius:calc(var(--radius) - 2px);background:linear-gradient(105deg,transparent 40%,rgba(255,255,255,.06) 50%,transparent 60%);background-size:200% 200%;animation:shimmer 2s linear infinite}
.pokeball-card-mini{width:44px;height:44px;opacity:.7;animation:float 2.5s ease-in-out infinite}
.reveal-hint{font-size:7px;color:rgba(255,215,0,.45);letter-spacing:2px;text-transform:uppercase;font-weight:800;position:relative;z-index:1}

/* Back revealed */
.flip-b{background:var(--bg-card);transform:rotateY(180deg);border:1.5px solid;padding:8px 6px;display:flex;flex-direction:column;align-items:center;overflow:hidden}
.poke-art-bg{border-radius:10px;width:100%;flex-shrink:0;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:5px}
.poke-art-bg img{width:80%;height:80%;object-fit:contain;display:block}
.poke-name{font-size:10px;font-weight:800;color:#fff;margin-bottom:3px;text-align:center;line-height:1.2;word-break:break-word}
.poke-types{display:flex;gap:3px;justify-content:center;flex-wrap:wrap;margin-bottom:4px}
.type-badge{font-size:7px;font-weight:800;text-transform:uppercase;letter-spacing:.3px;color:#fff;padding:2px 5px;border-radius:5px;white-space:nowrap}
.poke-flavor{font-size:8px;color:rgba(255,255,255,.4);font-style:italic;line-height:1.3;text-align:center;word-break:break-word;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}

.btn-reveal-all{width:100%;padding:10px;background:linear-gradient(90deg,rgba(255,215,0,.1),rgba(255,215,0,.04));border:1px dashed rgba(255,215,0,.25);border-radius:12px;color:var(--yellow);font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;cursor:pointer;margin-bottom:16px;letter-spacing:1px;transition:background .2s}
.btn-reveal-all:hover{background:linear-gradient(90deg,rgba(255,215,0,.2),rgba(255,215,0,.08))}

/* ‚îÄ‚îÄ DNA SONGS ‚îÄ‚îÄ */
.dna-section{background:var(--bg-mid);border-radius:18px;padding:16px;margin-bottom:18px}
.dna-title{font-size:16px;font-weight:800;text-align:center;margin-bottom:14px}
.song-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.05)}
.song-row:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
.song-num{font-size:11px;font-weight:800;color:var(--text3);min-width:18px;padding-top:2px}
.song-info{flex:1;min-width:0}
.song-name{font-size:12px;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.song-artist{font-size:10px;color:var(--text2);margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.song-convoke{font-size:10px;color:var(--text3);font-style:italic}
.song-types{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.song-type-badge{font-size:8px;font-weight:800;text-transform:uppercase;color:#fff;padding:2px 6px;border-radius:5px;white-space:nowrap}

/* ‚îÄ‚îÄ SHARE MODAL ‚îÄ‚îÄ */
.share-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:none;align-items:center;justify-content:center;padding:16px}
.share-modal-bg.open{display:flex}
.share-modal{background:var(--bg-mid);border-radius:20px;padding:20px;width:100%;max-width:380px;border:1px solid rgba(255,255,255,.1)}
.share-modal h3{font-size:16px;font-weight:800;margin-bottom:16px;text-align:center}
.share-preview{border-radius:14px;overflow:hidden;margin-bottom:16px;border:1px solid rgba(255,255,255,.1)}
.share-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.share-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:10px;border-radius:10px;border:none;cursor:pointer;font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;transition:transform .15s}
.share-btn:hover{transform:scale(1.04)}
.share-btn.whatsapp{background:#25D366;color:#fff}
.share-btn.twitter{background:#1DA1F2;color:#fff}
.share-btn.instagram{background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045);color:#fff}
.share-btn.tiktok{background:#000;color:#fff;border:1px solid #333}
.share-btn.facebook{background:#1877F2;color:#fff}
.share-btn.download{background:var(--green);color:#fff}
.btn-close-modal{width:100%;padding:10px;background:none;border:1px solid rgba(255,255,255,.15);border-radius:10px;color:var(--text2);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;cursor:pointer}
.btn-close-modal:hover{border-color:rgba(255,255,255,.3)}

/* Share card (off-screen render) 1080x1920 = 9:16 */
#share-card-render{
  position:fixed;left:-9999px;top:0;
  width:1080px;height:1920px;
  background:#0d1117;
  padding:80px 72px;
  font-family:'Nunito',sans-serif;
  display:flex;flex-direction:column;align-items:center;justify-content:space-between;
  overflow:hidden;
}
/* BG glow layers */
#share-card-render::before{content:'';position:absolute;top:-100px;left:-100px;width:700px;height:700px;border-radius:50%;background:radial-gradient(circle,rgba(29,185,84,.12) 0%,transparent 70%);pointer-events:none}
#share-card-render::after{content:'';position:absolute;bottom:-100px;right:-100px;width:700px;height:700px;border-radius:50%;background:radial-gradient(circle,rgba(255,215,0,.08) 0%,transparent 70%);pointer-events:none}
.sc-top{text-align:center;width:100%;position:relative;z-index:1}
.sc-pokeball-logo{width:120px;height:120px;margin:0 auto 40px}
.sc-app-name{font-size:72px;font-weight:900;letter-spacing:-2px;margin-bottom:12px}
.sc-app-name span{color:#1DB954}
.sc-subtitle{font-size:32px;color:rgba(255,255,255,.5);margin-bottom:48px;font-weight:600}
.sc-user{font-size:40px;color:#1DB954;font-weight:800;margin-bottom:20px}
.sc-medal{display:inline-flex;align-items:center;gap:12px;background:rgba(255,215,0,.12);border:2px solid rgba(255,215,0,.35);border-radius:60px;padding:14px 32px;font-size:32px;font-weight:800;color:#FFD700;margin-bottom:36px}
.sc-badges{display:flex;flex-wrap:wrap;justify-content:center;gap:14px;margin-bottom:10px}
.sc-badge{padding:10px 24px;border-radius:30px;font-size:26px;font-weight:700;border:2px solid}
.sc-grid-wrap{width:100%;position:relative;z-index:1}
.sc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:48px;width:100%}
.sc-poke{background:linear-gradient(135deg,#0f2847,#0d1a33);border-radius:28px;padding:28px 16px;text-align:center;border:2px solid}
.sc-poke img{width:180px;height:180px;object-fit:contain}
.sc-poke-name{font-size:26px;font-weight:800;color:#fff;margin-top:12px}
.sc-poke-types{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
.sc-type-badge{font-size:18px;font-weight:800;text-transform:uppercase;color:#fff;padding:5px 14px;border-radius:10px}
.sc-songs{width:100%;position:relative;z-index:1;margin-bottom:20px}
.sc-songs-title{font-size:30px;font-weight:800;text-align:center;margin-bottom:16px;color:rgba(255,255,255,.7)}
.sc-song-row{display:flex;align-items:center;gap:16px;margin-bottom:10px;background:rgba(255,255,255,.04);border-radius:12px;padding:12px 20px}
.sc-song-num{font-size:20px;font-weight:800;color:rgba(255,255,255,.25);min-width:28px}
.sc-song-info{flex:1;min-width:0}
.sc-song-name{font-size:22px;font-weight:800;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sc-song-artist{font-size:17px;color:rgba(255,255,255,.45)}
.sc-footer-wrap{text-align:center;position:relative;z-index:1}
.sc-hashtag{font-size:52px;font-weight:900;color:#1DB954;margin-bottom:8px}
.sc-attr{font-size:24px;color:rgba(255,255,255,.2)}

/* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
.actions{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:22px}
.btn-share-main{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,var(--green),#17a34a);color:#fff;font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;border:none;border-radius:50px;cursor:pointer;padding:13px 26px;box-shadow:0 0 20px rgba(29,185,84,.25);transition:transform .15s}
.btn-share-main:hover{transform:scale(1.04)}
.btn-regen{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,rgba(138,43,226,.25),rgba(106,13,173,.25));border:1px solid rgba(138,43,226,.4);color:#c084fc;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;border-radius:50px;cursor:pointer;padding:10px 22px;transition:transform .15s}
.btn-regen:hover{transform:scale(1.04)}
.btn-reset{background:none;border:none;color:var(--text3);font-family:'Nunito',sans-serif;font-size:12px;font-weight:600;cursor:pointer;padding:6px}
.btn-reset:hover{color:var(--text2)}

.res-footer{text-align:center}
.hashtag{color:var(--green);font-size:14px;font-weight:800;margin-bottom:4px}
.res-attr{font-size:10px;color:var(--text3);opacity:.6}

/* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
#error{flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px;gap:16px}
#error h2{font-size:22px;font-weight:800}
#error p{color:var(--text2);font-size:14px;max-width:300px;line-height:1.6}
</style>
</head>
<body>
<div class="sparkles-overlay" id="sparkles-overlay"></div>

<!-- SHARE CARD (off-screen for canvas render) -->
<div id="share-card-render"></div>

<!-- SHARE MODAL -->
<div class="share-modal-bg" id="share-modal-bg" onclick="closeShareModal(event)">
  <div class="share-modal">
    <h3>üîó Compartir mi equipo</h3>
    <div class="share-preview" id="share-preview-img"></div>
    <div class="share-buttons">
      <button class="share-btn whatsapp" onclick="shareToApp('whatsapp')">üì± WhatsApp</button>
      <button class="share-btn twitter" onclick="shareToApp('twitter')">üê¶ Twitter/X</button>
      <button class="share-btn instagram" onclick="shareToApp('instagram')">üì∏ Instagram</button>
      <button class="share-btn facebook" onclick="shareToApp('facebook')">üìò Facebook</button>
      <button class="share-btn tiktok" onclick="shareToApp('tiktok')">üéµ TikTok</button>
      <button class="share-btn download" onclick="downloadImage()">‚¨áÔ∏è Guardar</button>
    </div>
    <button class="btn-close-modal" onclick="closeShareModal()">Cerrar</button>
  </div>
</div>

<!-- LANDING -->
<div id="landing" class="screen active">
  <div class="pokeball-wrap">
    <svg class="pokeball-svg" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="48" fill="#1a1a2e" stroke="#1DB954" stroke-width="2"/>
      <path d="M50 2 A48 48 0 0 1 98 50 L2 50 A48 48 0 0 1 50 2Z" fill="#cc2200"/>
      <path d="M50 98 A48 48 0 0 1 2 50 L98 50 A48 48 0 0 1 50 98Z" fill="#1a1a2e"/>
      <line x1="2" y1="50" x2="98" y2="50" stroke="#1DB954" stroke-width="2.5"/>
      <circle cx="50" cy="50" r="14" fill="#1a1a2e" stroke="#1DB954" stroke-width="2.5"/>
      <circle cx="50" cy="50" r="7" fill="#fff" opacity=".9"/>
    </svg>
  </div>
  <h1 class="title">Pok√©<span>Beats</span></h1>
  <p class="tagline">Descubre el equipo Pok√©mon que tu m√∫sica ha elegido para ti</p>
  <div class="divider"></div>
  <p class="desc">Conecta tu cuenta de Spotify y descubre qu√© Pok√©mon representan tus gustos musicales de este mes</p>
  <button class="btn-spotify" onclick="startAuth()">
    <svg viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
    Conectar con Spotify
  </button>
  <p class="attribution">Powered by Spotify API + Pok√©API</p>
</div>

<!-- LOADING -->
<div id="loading" class="screen">
  <svg class="spin-ball" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="48" fill="#0f2847" stroke="#1DB954" stroke-width="2"/>
    <path d="M50 2 A48 48 0 0 1 98 50 L2 50 A48 48 0 0 1 50 2Z" fill="#cc2200"/>
    <path d="M50 98 A48 48 0 0 1 2 50 L98 50 A48 48 0 0 1 50 98Z" fill="#0f2847"/>
    <line x1="2" y1="50" x2="98" y2="50" stroke="#1DB954" stroke-width="2.5"/>
    <circle cx="50" cy="50" r="12" fill="#0f2847" stroke="#1DB954" stroke-width="2.5"/>
    <circle cx="50" cy="50" r="6" fill="#fff" opacity=".9"/>
  </svg>
  <div id="loading-msg">Analizando tu m√∫sica...</div>
  <div id="loading-sub">Capturando tu equipo Pok√©mon ‚ö°</div>
</div>

<!-- MEDAL SCREEN -->
<div id="medal-screen" class="screen">
  <p class="medal-intro">Tu vibra musical de este mes te ha ganado una medalla especial...</p>
  <div class="card-scene" id="card-scene" onclick="revealMedal()">
    <div class="card-body spinning" id="card-body">
      <!-- Mystery back -->
      <div class="card-side card-back">
        <svg class="pokeball-on-card" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="48" fill="#1a1a2e" stroke="rgba(255,215,0,.6)" stroke-width="2.5"/>
          <path d="M50 2 A48 48 0 0 1 98 50 L2 50 A48 48 0 0 1 50 2Z" fill="#cc2200"/>
          <path d="M50 98 A48 48 0 0 1 2 50 L98 50 A48 48 0 0 1 50 98Z" fill="#1a1a2e"/>
          <line x1="2" y1="50" x2="98" y2="50" stroke="rgba(255,215,0,.6)" stroke-width="2.5"/>
          <circle cx="50" cy="50" r="14" fill="#1a1a2e" stroke="rgba(255,215,0,.6)" stroke-width="2.5"/>
          <circle cx="50" cy="50" r="7" fill="rgba(255,215,0,.8)" opacity=".9"/>
        </svg>
        <div class="mystery-symbol">‚ú® MEDALLA ‚ú®</div>
      </div>
      <!-- Medal front -->
      <div class="card-side card-front">
        <div class="medal-emoji-big" id="medal-emoji">üèÖ</div>
        <div class="medal-name-big" id="medal-name">Medalla</div>
        <div class="medal-desc-text" id="medal-desc">...</div>
      </div>
    </div>
  </div>
  <p class="tap-hint" id="tap-hint">‚ú® Toca la carta para revelar tu medalla</p>
  <button class="btn-gold" id="btn-gold" onclick="goToResults()">‚ö° Ver mi equipo Pok√©mon</button>
</div>

<!-- RESULTS -->
<div id="results" class="screen">
  <div class="results-inner" id="results-inner"></div>
</div>

<!-- ERROR -->
<div id="error" class="screen">
  <div style="font-size:48px">üòµ</div>
  <h2>Algo sali√≥ mal</h2>
  <p id="error-msg">No pudimos conectar con Spotify.</p>
  <button class="btn-spotify" onclick="showScreen('landing')">Volver al inicio</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const CLIENT_ID = 'ee6b358b259b4b849f66c397eb935dc3';
const REDIRECT_URI = window.location.origin + window.location.pathname;
const SCOPES = 'user-top-read';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let _user=null,_genres=null,_team=null,_medal=null,_topTracks=null,_artistGenreMap=null;
let _medalRevealed=false;
let _shareImageBlob=null;

// ‚îÄ‚îÄ MEDALS ‚îÄ‚îÄ
const MEDALS=[
  {emoji:'üî•',name:'Medalla Llama',desc:'Tu m√∫sica arde con intensidad. Eres pura energ√≠a en cada escucha.',types:['fire','fighting']},
  {emoji:'üíß',name:'Medalla Oc√©ano',desc:'Tu alma fluye como el agua. Profundo, libre y sin l√≠mites.',types:['water','ice']},
  {emoji:'‚ö°',name:'Medalla Tormenta',desc:'Electrizante. Tu playlist descarga voltaje en cada canci√≥n.',types:['electric']},
  {emoji:'üåø',name:'Medalla Selva',desc:'Conectado con lo natural. Tu m√∫sica tiene ra√≠ces aut√©nticas.',types:['grass','ground']},
  {emoji:'üîÆ',name:'Medalla Ps√≠quica',desc:'Mente elevada, emociones profundas. Tu m√∫sica trasciende lo ordinario.',types:['psychic','fairy']},
  {emoji:'üåô',name:'Medalla Lunar',desc:'Oscuro y misterioso. Tu m√∫sica vive en las sombras del alma.',types:['dark','ghost','poison']},
  {emoji:'üèîÔ∏è',name:'Medalla Cima',desc:'√âpico y majestuoso. Suenas como la banda sonora de una batalla legendaria.',types:['dragon','rock','steel']},
  {emoji:'ü•ä',name:'Medalla Combate',desc:'Directo al grano. Tu m√∫sica golpea fuerte y sin filtros.',types:['fighting','rock']},
  {emoji:'üåü',name:'Medalla Estelar',desc:'Vers√°til y brillante. Tu m√∫sica refleja todos los colores del universo.',types:['normal','flying']},
  {emoji:'üé∏',name:'Medalla Rebelde',desc:'Con causa propia. Tu m√∫sica sacude paredes y rompe moldes.',types:['steel','poison']},
];
function getMedal(g){if(!g.length)return MEDALS[Math.floor(Math.random()*MEDALS.length)];const t=g[0].type;return MEDALS.find(m=>m.types.includes(t))||MEDALS[Math.floor(Math.random()*MEDALS.length)]}

// ‚îÄ‚îÄ TYPE DATA ‚îÄ‚îÄ
const TC={normal:'#A8A878',fire:'#F08030',water:'#6890F0',electric:'#F8D030',grass:'#78C850',poison:'#A040A0',ground:'#E0C068',flying:'#A890F0',psychic:'#F85888',rock:'#B8A038',steel:'#B8B8D0',fighting:'#C03028',dragon:'#7038F8',dark:'#705848',fairy:'#EE99AC',ghost:'#705898',ice:'#98D8D8',bug:'#A8B820'};
const TL={normal:'Normal',fire:'Fuego',water:'Agua',electric:'El√©ctrico',grass:'Planta',poison:'Veneno',ground:'Tierra',flying:'Volador',psychic:'Ps√≠quico',rock:'Roca',steel:'Acero',fighting:'Lucha',dragon:'Drag√≥n',dark:'Siniestro',fairy:'Hada',ghost:'Fantasma',ice:'Hielo',bug:'Bicho'};

const GENRE_RULES=[
  {keywords:['k-pop','kpop'],type:'fairy',label:'K-Pop'},
  {keywords:['j-pop','jpop'],type:'fairy',label:'J-Pop'},
  {keywords:['neo-soul','neo soul'],type:'psychic',label:'Neo Soul'},
  {keywords:['hard-rock','hard rock','hardcore'],type:'rock',label:'Hard Rock'},
  {keywords:['hip-hop','hip hop','rap','hiphop'],type:'fighting',label:'Hip-Hop'},
  {keywords:['r-n-b','rnb','r&b','soul'],type:'psychic',label:'R&B'},
  {keywords:['reggaeton','reggaet√≥n','latin','salsa','latino','tropical','bachata','cumbia'],type:'fire',label:'Reggaet√≥n'},
  {keywords:['electronic','edm','house','techno','dance','electro','trance','dubstep'],type:'electric',label:'Electr√≥nica'},
  {keywords:['classical','orchestral','instrumental','orchestra','symphony','piano'],type:'dragon',label:'Cl√°sica'},
  {keywords:['indie','alternative'],type:'poison',label:'Indie'},
  {keywords:['reggae','dub','ska'],type:'grass',label:'Reggae'},
  {keywords:['folk','country','acoustic','americana'],type:'ground',label:'Folk'},
  {keywords:['funk','disco'],type:'ghost',label:'Funk'},
  {keywords:['punk'],type:'dark',label:'Punk'},
  {keywords:['trap','drill'],type:'dark',label:'Trap'},
  {keywords:['ambient','new-age','chill','lo-fi','lofi'],type:'flying',label:'Ambient'},
  {keywords:['gospel','worship'],type:'flying',label:'Gospel'},
  {keywords:['jazz','blues'],type:'water',label:'Jazz'},
  {keywords:['metal','metalcore'],type:'steel',label:'Metal'},
  {keywords:['rock'],type:'rock',label:'Rock'},
  {keywords:['pop'],type:'normal',label:'Pop'},
];

const FLAVOR=['Tu amor por','Tu pasi√≥n por','Tu vibra con','Tu conexi√≥n con','Tu devoci√≥n por','Tu energ√≠a de'];

// ‚îÄ‚îÄ POKEBALL SVG for cards ‚îÄ‚îÄ
const POKEBALL_SVG=`<svg viewBox="0 0 100 100" class="pokeball-card-mini"><circle cx="50" cy="50" r="48" fill="#1a1a2e" stroke="rgba(255,215,0,.5)" stroke-width="2.5"/><path d="M50 2 A48 48 0 0 1 98 50 L2 50 A48 48 0 0 1 50 2Z" fill="#cc2200"/><path d="M50 98 A48 48 0 0 1 2 50 L98 50 A48 48 0 0 1 50 98Z" fill="#1a1a2e"/><line x1="2" y1="50" x2="98" y2="50" stroke="rgba(255,215,0,.5)" stroke-width="2.5"/><circle cx="50" cy="50" r="14" fill="#1a1a2e" stroke="rgba(255,215,0,.5)" stroke-width="2.5"/><circle cx="50" cy="50" r="7" fill="rgba(255,215,0,.7)"/></svg>`;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function cap(n){return n.split('-').map(p=>p[0].toUpperCase()+p.slice(1)).join(' ')}
async function sha256(s){return crypto.subtle.digest('SHA-256',new TextEncoder().encode(s))}
function b64url(buf){const b=new Uint8Array(buf);let s='';b.forEach(x=>s+=String.fromCharCode(x));return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
function rstr(len){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';const a=new Uint8Array(len);crypto.getRandomValues(a);return Array.from(a).map(x=>c[x%c.length]).join('')}

// ‚îÄ‚îÄ SPARKLES ‚îÄ‚îÄ
function sparkle(cx,cy){
  const ov=document.getElementById('sparkles-overlay');ov.classList.add('on');ov.innerHTML='';
  const cols=['#FFD700','#FF69B4','#00BFFF','#7FFF00','#FF6347','#DA70D6','#fff','#1DB954'];
  for(let i=0;i<55;i++){
    const el=document.createElement('div');el.className='sparkle';
    const ang=Math.random()*360,dist=60+Math.random()*160;
    const tx=Math.cos(ang*Math.PI/180)*dist,ty=Math.sin(ang*Math.PI/180)*dist;
    el.style.cssText=`left:${cx}px;top:${cy}px;width:${4+Math.random()*9}px;height:${4+Math.random()*9}px;background:${cols[Math.floor(Math.random()*cols.length)]};--tx:${tx}px;--ty:${ty}px;animation-delay:${Math.random()*.35}s;animation-duration:${.7+Math.random()*.8}s`;
    ov.appendChild(el);
  }
  setTimeout(()=>ov.classList.remove('on'),2500);
}

// ‚îÄ‚îÄ MEDAL REVEAL ‚îÄ‚îÄ
function showMedalScreen(medal){
  _medal=medal;_medalRevealed=false;
  document.getElementById('medal-emoji').textContent=medal.emoji;
  document.getElementById('medal-name').textContent=medal.name;
  document.getElementById('medal-desc').textContent=medal.desc;
  const body=document.getElementById('card-body');
  body.className='card-body spinning';
  body.style.transform='';body.style.transition='';
  document.getElementById('btn-gold').className='btn-gold';
  document.getElementById('tap-hint').style.opacity='1';
  showScreen('medal-screen');
}

function revealMedal(){
  if(_medalRevealed)return;_medalRevealed=true;
  const body=document.getElementById('card-body');
  const scene=document.getElementById('card-scene');
  // Stop spin, flip
  body.className='card-body';
  body.style.transition='transform 1s cubic-bezier(.4,0,.2,1)';
  body.style.transform='rotateY(180deg)';
  const rect=scene.getBoundingClientRect();
  setTimeout(()=>{
    sparkle(rect.left+rect.width/2,rect.top+rect.height/2);
    document.getElementById('tap-hint').style.opacity='0';
    document.getElementById('btn-gold').className='btn-gold show';
  },700);
}

function goToResults(){renderResults()}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function startAuth(){
  const v=rstr(64);localStorage.setItem('pkce_v',v);
  const ch=b64url(await sha256(v));
  const p=new URLSearchParams({client_id:CLIENT_ID,response_type:'code',redirect_uri:REDIRECT_URI,scope:SCOPES,code_challenge_method:'S256',code_challenge:ch});
  window.location.href=`https://accounts.spotify.com/authorize?${p}`;
}
async function exchangeCode(code){
  const v=localStorage.getItem('pkce_v')||'';
  const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:'authorization_code',code,redirect_uri:REDIRECT_URI,code_verifier:v})});
  if(!r.ok)throw new Error('Token exchange failed');
  const d=await r.json();localStorage.setItem('sp_tk',d.access_token);localStorage.removeItem('pkce_v');return d.access_token;
}
async function spGet(ep,tk){
  const r=await fetch(`https://api.spotify.com/v1${ep}`,{headers:{Authorization:`Bearer ${tk}`}});
  if(r.status===401){localStorage.removeItem('sp_tk');throw new Error('Token expired')}
  if(!r.ok)throw new Error('Spotify error');return r.json();
}

// ‚îÄ‚îÄ GENRE ANALYSIS ‚îÄ‚îÄ
function analyzeGenres(artists){
  const m=new Map();
  for(const a of artists){const used=new Set();for(const g of a.genres){const gl=g.toLowerCase();for(const r of GENRE_RULES){if(used.has(r.label))continue;if(r.keywords.some(k=>gl.includes(k))){const key=`${r.type}_${r.label}`;m.set(key,{label:r.label,type:r.type,count:(m.get(key)?.count||0)+1});used.add(r.label);break}}}}
  return[...m.values()].sort((a,b)=>b.count-a.count);
}

// Map artist ID -> types based on their genres
function buildArtistTypeMap(artists){
  const map=new Map();
  for(const a of artists){
    const types=[];
    const used=new Set();
    for(const g of a.genres){
      const gl=g.toLowerCase();
      for(const r of GENRE_RULES){
        if(used.has(r.type))continue;
        if(r.keywords.some(k=>gl.includes(k))){
          types.push(r.type);used.add(r.type);
          if(types.length>=2)break;
        }
      }
      if(types.length>=2)break;
    }
    map.set(a.id,{name:a.name,types:types.length?types:['normal']});
  }
  return map;
}

// Get song rows from top tracks + artist type map
function buildSongRows(tracks,artistMap){
  const rows=[];
  for(const track of tracks.slice(0,6)){
    const artist=track.artists[0];
    const info=artistMap.get(artist.id);
    const types=info?info.types:['normal'];
    rows.push({song:track.name,artist:artist.name,types});
  }
  return rows;
}

// ‚îÄ‚îÄ POK√âAPI ‚îÄ‚îÄ
async function getTypePokemons(t){
  const r=await fetch(`https://pokeapi.co/api/v2/type/${t}`);const d=await r.json();
  return d.pokemon.map(p=>p.pokemon).filter(p=>{const id=parseInt(p.url.split('/').filter(Boolean).pop(),10);return id>0&&id<900});
}
async function getPokemon(name){
  const r=await fetch(`https://pokeapi.co/api/v2/pokemon/${name}`);const d=await r.json();
  return{id:d.id,name:d.name,sprite:d.sprites.other['official-artwork'].front_default||d.sprites.front_default,types:d.types.map(t=>t.type.name)};
}
async function buildTeam(genres){
  const slots=[],used=new Set();
  for(const g of genres){if(slots.length>=6)break;if(!used.has(g.type)){slots.push(g);used.add(g.type)}}
  const fb=['fire','water','grass','electric','psychic','dragon','fairy','steel','fighting','rock'];
  for(const f of fb){if(slots.length>=6)break;if(!used.has(f)){slots.push({type:f,label:TL[f]||f,count:0});used.add(f)}}
  const lists=await Promise.all(slots.map(s=>getTypePokemons(s.type)));
  const usedN=new Set(),picks=[];
  for(let i=0;i<slots.length;i++){const av=lists[i].filter(p=>!usedN.has(p.name));if(!av.length)continue;const pk=av[Math.floor(Math.random()*av.length)];usedN.add(pk.name);picks.push({name:pk.name,si:i})}
  const details=await Promise.all(picks.map(p=>getPokemon(p.name).catch(()=>null)));
  const team=[];
  for(let i=0;i<picks.length;i++){const d=details[i];if(!d)continue;const s=slots[picks[i].si];team.push({...d,matchedType:s.type,matchedGenre:s.label,flavor:`${FLAVOR[i%FLAVOR.length]} ${s.label} convoc√≥ a ${cap(d.name)}`})}
  return team;
}

// ‚îÄ‚îÄ FLIP CARDS ‚îÄ‚îÄ
function flipCard(wrap){
  const inner=wrap.querySelector('.flip-inner');
  if(inner.classList.contains('flipped'))return;
  inner.classList.add('flipped');
  const rect=wrap.getBoundingClientRect();
  sparkle(rect.left+rect.width/2,rect.top+rect.height/2);
}
function revealAll(){document.querySelectorAll('.flip-wrap').forEach((w,i)=>setTimeout(()=>flipCard(w),i*130))}

// ‚îÄ‚îÄ SHARE AS IMAGE ‚îÄ‚îÄ
let _shareBlob=null;

async function openShareModal(){
  const card=document.getElementById('share-card-render');

  // Pokeball SVG logo
  const pbLogo=`<svg class="sc-pokeball-logo" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="48" fill="#1a1a2e" stroke="#1DB954" stroke-width="2.5"/>
    <path d="M50 2 A48 48 0 0 1 98 50 L2 50 A48 48 0 0 1 50 2Z" fill="#cc2200"/>
    <path d="M50 98 A48 48 0 0 1 2 50 L98 50 A48 48 0 0 1 50 98Z" fill="#1a1a2e"/>
    <line x1="2" y1="50" x2="98" y2="50" stroke="#1DB954" stroke-width="2.5"/>
    <circle cx="50" cy="50" r="14" fill="#1a1a2e" stroke="#1DB954" stroke-width="2.5"/>
    <circle cx="50" cy="50" r="7" fill="#fff" opacity=".9"/>
  </svg>`;

  const badges=_genres.slice(0,4).map(g=>{
    const c=TC[g.type]||'#888';
    return`<span class="sc-badge" style="color:${c};background:${c}22;border-color:${c}55">${g.label}</span>`;
  }).join('');

  const pokeGrid=_team.map(p=>{
    const tc=TC[p.matchedType]||'#888';
    const tb=p.types.map(t=>`<span class="sc-type-badge" style="background:${TC[t]||'#888'}">${TL[t]||t}</span>`).join('');
    return`<div class="sc-poke" style="border-color:${tc}55;box-shadow:0 0 40px ${tc}22">
      <img src="${p.sprite}" crossorigin="anonymous" style="width:180px;height:180px;object-fit:contain">
      <div class="sc-poke-name">${cap(p.name)}</div>
      <div class="sc-poke-types">${tb}</div>
    </div>`;
  }).join('');

  // Songs section
  let songsHtml='';
  if(_topTracks&&_topTracks.length){
    _topTracks.slice(0,10).forEach((track,i)=>{
      const art=track.artists&&track.artists[0]?track.artists[0]:null;
      songsHtml+=`<div class="sc-song-row">
        <div class="sc-song-num">${i+1}</div>
        <div class="sc-song-info">
          <div class="sc-song-name">${track.name}</div>
          <div class="sc-song-artist">${art?art.name:''}</div>
        </div>
      </div>`;
    });
  }

  card.innerHTML=`
    <div class="sc-top">
      ${pbLogo}
      <div class="sc-app-name">Pok√©<span>Beats</span></div>
      <div class="sc-subtitle">Tu equipo Pok√©mon de este mes</div>
      ${_user?.display_name?`<div class="sc-user">${_user.display_name}</div>`:''}
      ${_medal?`<div class="sc-medal">${_medal.emoji} ${_medal.name}</div>`:''}
      <div class="sc-badges">${badges}</div>
    </div>

    <div class="sc-grid-wrap">
      <div class="sc-grid">${pokeGrid}</div>
    </div>

    ${songsHtml?`<div class="sc-songs">
      <div class="sc-songs-title">üéµ Top 10 canciones del mes</div>
      ${songsHtml}
    </div>`:''}

    <div class="sc-footer-wrap">
      <div class="sc-hashtag">#Pok√©Beats</div>
      <div class="sc-attr">Powered by Spotify API + Pok√©API</div>
    </div>`;

  // Wait for images to load
  await Promise.all([...card.querySelectorAll('img')].map(img=>new Promise(res=>{
    if(img.complete)res();else{img.onload=res;img.onerror=res}
  })));

  // Render to canvas at exactly 1080x1920
  const preview=document.getElementById('share-preview-img');
  try{
    const canvas=await html2canvas(card,{
      backgroundColor:'#0d1117',
      scale:1,
      width:1080,
      height:1920,
      useCORS:true,
      logging:false,
      windowWidth:1080,
      windowHeight:1920,
    });
    _shareBlob=await new Promise(res=>canvas.toBlob(b=>res(b),'image/png'));
    preview.innerHTML=`<img src="${canvas.toDataURL()}" style="width:100%;border-radius:10px;aspect-ratio:9/16;object-fit:cover">`;
  }catch(e){
    preview.innerHTML='<div style="padding:16px;color:var(--text2);text-align:center;font-size:12px">Vista previa no disponible</div>';
  }
  document.getElementById('share-modal-bg').classList.add('open');
}

function closeShareModal(e){
  if(!e||e.target===document.getElementById('share-modal-bg')){
    document.getElementById('share-modal-bg').classList.remove('open');
  }
}

async function shareToApp(platform){
  const text=`üéµ Mi equipo Pok√©Beats este mes:\n${_team.map((p,i)=>`${i+1}. ${cap(p.name)} (${p.matchedGenre})`).join('\n')}\n\n#Pok√©Beats ‚ö°`;
  const url='https://pokebeats.app';
  const urls={
    whatsapp:`https://wa.me/?text=${encodeURIComponent(text+'\n'+url)}`,
    twitter:`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
    facebook:`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`,
    instagram:null,
    tiktok:null,
  };
  if(platform==='instagram'||platform==='tiktok'){
    // For Instagram/TikTok: download image + copy text
    await downloadImage();
    await navigator.clipboard?.writeText(text).catch(()=>{});
    alert(`üì∏ Imagen guardada + texto copiado al portapapeles.\nP√©galo en ${platform==='instagram'?'Instagram':'TikTok'} al compartir.`);
    return;
  }
  if(urls[platform])window.open(urls[platform],'_blank');
}

async function downloadImage(){
  if(!_shareBlob)return;
  const url=URL.createObjectURL(_shareBlob);
  const a=document.createElement('a');a.href=url;a.download='mi-equipo-pokebeats.png';a.click();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
}

// ‚îÄ‚îÄ RENDER RESULTS ‚îÄ‚îÄ
function renderResults(){
  const c=document.getElementById('results-inner');
  const badges=_genres.slice(0,4).map(g=>{const col=TC[g.type]||'#888';return`<span class="badge" style="color:${col};background:${col}22;border-color:${col}55">${g.label}</span>`}).join('');

  // Team cards
  const cards=_team.map((p,i)=>{
    const tc=TC[p.matchedType]||'#888';
    const artH=Math.min(55,48)+'%'; // responsive art height
    const tb=p.types.map(t=>`<span class="type-badge" style="background:${TC[t]||'#888'}">${TL[t]||t}</span>`).join('');
    return`<div class="flip-wrap" onclick="flipCard(this)">
      <div class="flip-inner">
        <div class="flip-f">${POKEBALL_SVG}<div class="reveal-hint">Revelar</div></div>
        <div class="flip-b" style="border-color:${tc}55;box-shadow:0 0 16px ${tc}2a">
          <div class="poke-art-bg" style="background:${tc}18;height:52%">
            <img src="${p.sprite}" alt="${p.name}" loading="lazy" style="width:80%;height:80%;object-fit:contain">
          </div>
          <div class="poke-name">${cap(p.name)}</div>
          <div class="poke-types">${tb}</div>
          <div class="poke-flavor">${p.flavor}</div>
        </div>
      </div>
    </div>`;
  }).join('');

  // Song rows (ADN Musical) - inline build to avoid empty string bug
  let songHtml='';
  if(_topTracks && _topTracks.length>0){
    _topTracks.slice(0,10).forEach((track,i)=>{
      const art=track.artists&&track.artists[0]?track.artists[0]:null;
      songHtml+=`<div class="song-row">
        <div class="song-num">${i+1}</div>
        <div class="song-info">
          <div class="song-name">${track.name}</div>
          <div class="song-artist">${art?art.name:''}</div>
        </div>
      </div>`;
    });
  }
  if(!songHtml) songHtml='<div style="text-align:center;color:var(--text3);font-size:13px;padding:8px">No se encontraron canciones este mes</div>';

  c.innerHTML=`
    <div class="res-header">
      <div class="zap-icon">‚ö°</div>
      <div class="res-title">Tu forma de vibrar con la m√∫sica ha capturado a tu equipo perfecto para las batallas Pok√©mon</div>
      ${_user?.display_name?`<div class="res-username">${_user.display_name}</div>`:''}
      ${_medal?`<div class="medal-mini-badge">${_medal.emoji} ${_medal.name}</div>`:''}
      <div class="badges">${badges}</div>
    </div>

    <button class="btn-reveal-all" onclick="revealAll()">‚ú® Revelar todo el equipo de una vez</button>
    <div class="team-grid">${cards}</div>

    <div class="dna-section">
      <div class="dna-title">üéµ Tus 10 canciones del mes</div>
      ${songHtml}
    </div>

    <div class="actions">
      <button class="btn-share-main" onclick="openShareModal()">üñºÔ∏è Compartir como imagen</button>
      <button class="btn-regen" onclick="regenTeam()">üé≤ Nuevo equipo (mismos g√©neros)</button>
      <button class="btn-reset" onclick="reset()">üîÑ Cambiar cuenta Spotify</button>
    </div>

    <div class="res-footer">
      <div class="hashtag">#Pok√©Beats</div>
      <div class="res-attr">Datos de Spotify API ¬∑ Pok√©mon de Pok√©API</div>
    </div>`;

  showScreen('results');
}

// ‚îÄ‚îÄ REGEN ‚îÄ‚îÄ
async function regenTeam(){
  const tk=localStorage.getItem('sp_tk');if(!tk){showScreen('landing');return}
  showScreen('loading');
  document.getElementById('loading-msg').textContent='Generando nuevo equipo...';
  document.getElementById('loading-sub').textContent='Diferentes Pok√©mon te esperan ‚ö°';
  try{_team=await buildTeam(_genres);renderResults()}
  catch(e){document.getElementById('error-msg').textContent=e.message;showScreen('error')}
}

function reset(){localStorage.removeItem('sp_tk');showScreen('landing')}

// ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ
async function main(){
  const p=new URLSearchParams(window.location.search);
  const code=p.get('code'),err=p.get('error');
  if(code||err)window.history.replaceState({},'',window.location.pathname);
  if(err){document.getElementById('error-msg').textContent='Autenticaci√≥n cancelada.';showScreen('error');return}

  let tk=localStorage.getItem('sp_tk');
  if(code&&!tk){
    showScreen('loading');document.getElementById('loading-msg').textContent='Conectando con Spotify...';
    try{tk=await exchangeCode(code)}catch(e){document.getElementById('error-msg').textContent='Error: '+e.message;showScreen('error');return}
  }
  if(!tk){showScreen('landing');return}

  showScreen('loading');
  try{
    document.getElementById('loading-msg').textContent='Obteniendo tus favoritos...';
    const[user,artists,tracksShort]=await Promise.all([
      spGet('/me',tk),
      spGet('/me/top/artists?time_range=short_term&limit=50',tk),
      spGet('/me/top/tracks?time_range=short_term&limit=10',tk)
    ]);

    // Tracks fallback: short -> medium -> long term
    let trackItems=tracksShort.items||[];
    if(!trackItems.length){
      const tm=await spGet('/me/top/tracks?time_range=medium_term&limit=10',tk);
      trackItems=tm.items||[];
    }
    if(!trackItems.length){
      const tl=await spGet('/me/top/tracks?time_range=long_term&limit=10',tk);
      trackItems=tl.items||[];
    }

    document.getElementById('loading-msg').textContent='Analizando g√©neros musicales...';
    let genres=analyzeGenres(artists.items);
    if(!genres.length){
      const fb=await spGet('/me/top/artists?time_range=medium_term&limit=50',tk);
      genres=analyzeGenres(fb.items);
    }

    // Build artist->type map from top artists
    const artistMap=buildArtistTypeMap(artists.items);

    // For track artists not in the map, also check medium_term artists
    if(trackItems.length){
      try{
        const artistsMed=await spGet('/me/top/artists?time_range=medium_term&limit=50',tk);
        const extraMap=buildArtistTypeMap(artistsMed.items||[]);
        extraMap.forEach((v,k)=>{ if(!artistMap.has(k)) artistMap.set(k,v); });
        const artistsLong=await spGet('/me/top/artists?time_range=long_term&limit=50',tk);
        const extraLong=buildArtistTypeMap(artistsLong.items||[]);
        extraLong.forEach((v,k)=>{ if(!artistMap.has(k)) artistMap.set(k,v); });
      }catch(e){console.log('Could not fetch medium/long artists',e)}
    }

    document.getElementById('loading-msg').textContent='Capturando tu equipo Pok√©mon...';
    const team=await buildTeam(genres);

    _user=user;_genres=genres;_team=team;
    _topTracks=trackItems;_artistGenreMap=artistMap;

    showMedalScreen(getMedal(genres));
  }catch(e){
    if(e.message.includes('Token expired'))showScreen('landing');
    else{document.getElementById('error-msg').textContent=e.message;showScreen('error')}
  }
}
main();
</script>
</body>
</html>
